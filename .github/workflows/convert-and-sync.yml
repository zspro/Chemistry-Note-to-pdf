name: Sync CNB PDF to 123Pan (Atomic)

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时检查
  workflow_dispatch:       # 手动触发

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 从 CNB 下载最新 PDF
    - name: Download from CNB
      run: |
        git clone --depth 1 https://cnb.cool/Seeridia/Chemistry-Note-File.git pdf-source
        echo "Downloaded:"
        du -sh pdf-source/

    # 2. 压缩为单个 ZIP（排除 git 和 markdown）
    - name: Create archive
      run: |
        cd pdf-source
        zip -r ../chemistry-notes-pdf.zip . -x "*.git*" -x "*.md"
        cd ..
        ls -lh chemistry-notes-pdf.zip

    # 3. 安装 rclone
    - name: Install rclone
      run: curl https://rclone.org/install.sh | sudo bash

    # 4. 配置 123 云盘（密码混淆加密）
    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        OBSCURED_PASS=$(rclone obscure "${{ secrets.WEBDAV_PASS }}")
        cat > ~/.config/rclone/rclone.conf << EOF
        [123pan]
        type = webdav
        url = ${{ secrets.WEBDAV_URL }}
        vendor = other
        user = ${{ secrets.WEBDAV_USER }}
        pass = $OBSCURED_PASS
        EOF

    # 5. 上传（时间戳版本 + 原子 MOVE 替换 latest）
    - name: Upload with atomic replace
      run: |
        REMOTE="123pan:/Chemistry-Notes"
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        VERSIONED="notes-${TIMESTAMP}.zip"
        
        echo "Step 1: Uploading timestamped version..."
        rclone copy chemistry-notes-pdf.zip "$REMOTE/$VERSIONED" --progress
        
        echo "Step 2: Atomic replace latest.zip using MOVE..."
        # 先删除旧的 latest（MOVE 要求目标不存在或覆盖）
        rclone delete "$REMOTE/latest.zip" 2>/dev/null || true
        
        # 使用 MOVE (201 支持) 原子重命名，无空窗期
        rclone moveto "$REMOTE/$VERSIONED" "$REMOTE/latest.zip"
        
        echo "Step 3: Cleaning old versions (keep last 2)..."
        # 保留最近 2 个时间戳版本（不包括 latest）
        rclone ls "$REMOTE" 2>/dev/null | \
          grep "notes-.*\.zip" | \
          grep -v "latest" | \
          sort -k2 | \
          head -n -2 | \
          awk '{print $2}' | \
        while read oldfile; do
          echo "Removing: $oldfile"
          rclone delete "$REMOTE/$oldfile" 2>/dev/null || true
        done
        
        echo "✅ Done! Current files:"
        rclone ls "$REMOTE/"
