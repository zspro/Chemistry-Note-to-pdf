name: Sync CNB PDF to 123Pan

于:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时检查
  workflow_dispatch:       # 手动触发

jobs:
  download-and-backup:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 直接从 CNB 克隆 PDF 仓库（公开仓库无需 token）
    - name: Download PDFs from CNB
      run: |
        git clone --depth 1 https://cnb.cool/Seeridia/Chemistry-Note-File.git pdf-source
        echo "Downloaded files:"
        ls -la pdf-source/
        find pdf-source -name "*.pdf" | wc -l

    # 2. 压缩（排除 .git 目录）
    - name: Create archive
      run: |
        cd pdf-source
        zip -r ../chemistry-notes-pdf.zip . -x "*.git*" -x "*.md"
        cd ..
        ls -lh chemistry-notes-pdf.zip

    # 3. 安装 rclone
    - name: Install rclone
      run: curl https://rclone.org/install.sh | sudo bash

    # 4. 配置 123 云盘
    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        OBSCURED_PASS=$(rclone obscure "${{ secrets.WEBDAV_PASS }}")
        cat > ~/.config/rclone/rclone.conf << EOF
        [123pan]
        type = webdav
        url = ${{ secrets.WEBDAV_URL }}
        vendor = other
        user = ${{ secrets.WEBDAV_USER }}
        pass = $OBSCURED_PASS
        EOF

    # 5. 上传并管理版本（保留最近2个，永不覆盖）
    - name: Upload to 123Pan (Versioned)
      run: |
        REMOTE_DIR="123pan:/Chemistry-Notes"
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        VERSIONED_NAME="chemistry-notes-${TIMESTAMP}.zip"
        
        echo "Step 1: Uploading $VERSIONED_NAME..."
        if ! rclone copy "chemistry-notes-pdf.zip" "$REMOTE_DIR/$VERSIONED_NAME" --progress; then
          echo "❌ Upload failed!"
          exit 1
        fi
        
        echo "Step 2: Updating latest link..."
        rclone delete "$REMOTE_DIR/chemistry-notes-latest.zip" 2>/dev/null || true
        rclone copy "$REMOTE_DIR/$VERSIONED_NAME" "$REMOTE_DIR/chemistry-notes-latest.zip"
        
        echo "Step 3: Cleaning old versions (keep last 2)..."
        rclone ls "$REMOTE_DIR" 2>/dev/null | \
          grep "chemistry-notes-.*\.zip" | \
          grep -v "latest" | \
          sort -k2 | \
          head -n -2 | \
          awk '{print $2}' | \
        while read oldfile; do
          echo "Deleting old version: $oldfile"
          rclone delete "$REMOTE_DIR/$oldfile" 2>/dev/null || true
        done
        
        echo "✅ Upload completed!"
        echo "Files on 123Pan:"
        rclone ls "$REMOTE_DIR/"
