name: Sync CNB PDF to 123Pan

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时检查
  workflow_dispatch:       # 手动触发

jobs:
  download-and-backup:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 直接从 CNB 克隆 PDF 仓库（公开仓库无需 token）
    - name: Download PDFs from CNB
      run: |
        git clone --depth 1 https://cnb.cool/Seeridia/Chemistry-Note-File.git pdf-source
        echo "Downloaded files:"
        ls -la pdf-source/
        find pdf-source -name "*.pdf" | wc -l

    # 2. 压缩（排除 .git 目录）
    - name: Create archive
      run: |
        cd pdf-source
        zip -r ../chemistry-notes-pdf.zip . -x "*.git*" -x "*.md"
        cd ..
        ls -lh chemistry-notes-pdf.zip

    # 3. 安装 rclone
    - name: Install rclone
      run: curl https://rclone.org/install.sh | sudo bash

    # 4. 配置 123 云盘
    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        OBSCURED_PASS=$(rclone obscure "${{ secrets.WEBDAV_PASS }}")
        cat > ~/.config/rclone/rclone.conf << EOF
        [123pan]
        type = webdav
        url = ${{ secrets.WEBDAV_URL }}
        vendor = other
        user = ${{ secrets.WEBDAV_USER }}
        pass = $OBSCURED_PASS
        EOF

    # 5. 上传到 123 云盘（清理旧文件）
    - name: Upload to 123Pan
      run: |
        rclone mkdir "123pan:/Chemistry-Notes" || true
        rclone delete "123pan:/Chemistry-Notes/" || true
        rclone copy "chemistry-notes-pdf.zip" "123pan:/Chemistry-Notes/" --progress
        echo "Upload completed!"
        rclone ls "123pan:/Chemistry-Notes/"
